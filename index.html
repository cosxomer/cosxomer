<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>COSX √ñMER DERS √áƒ∞ZELGESƒ∞ - LUXURY EDITION</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;900&display=swap" rel="stylesheet">
    
    <style>
        /* ======================================= */
        /* TEMEL STƒ∞LLER VE TEMA DEƒûƒ∞≈ûKENLERƒ∞ */
        /* ======================================= */
        :root {
            /* Varsayƒ±lan Tema (Luxury Dark Mode - Odak) */
            --bg-color: #0d1117; /* GitHub Dark */
            --container-bg: #161b22;
            --header-bg: #010409;
            --header-text: #ffffff;
            --text-color: #c9d1d9; /* A√ßƒ±k Gri Metin */
            --border-color: #30363d;
            --day-bg: #161b22; 
            --accent-color: #38bdf8; /* L√ºks Mavi (Liderlik) */
            --button-bg: #21262d; 
            --button-hover: #30363d;
            --progress-bg: #30363d;
            --progress-fill: #38bdf8;
            --pomodoro-bg: #21262d;
            --pomodoro-accent: #f87171; /* Kƒ±rmƒ±zƒ± (Timer) */
            --reset-btn-bg: #9ca3af; 
            --reset-btn-hover: #6b7280;
            --logo-content: "LUXURY MANAGEMENT PANEL"; 
            --logo-accent: #38bdf8;
            --task-bg: #21262d;
            --task-completed-bg: #1e293b;
            --day-header-color: #e5e7eb;
        }

        /* LIGHT MODE - Temanƒ±n K√∂kten Deƒüi≈ümesi */
        body[data-theme="light"] {
            --bg-color: #f7f9fc; 
            --container-bg: #ffffff;
            --header-bg: #1f2937; 
            --header-text: #ffffff;
            --text-color: #374151; 
            --border-color: #e5e7eb; 
            --day-bg: #ffffff; 
            --accent-color: #059669; /* Ye≈üil */
            --button-bg: #4f46e5;
            --button-hover: #4338ca;
            --progress-bg: #f3f4f6;
            --progress-fill: #059669;
            --pomodoro-bg: #ffffff;
            --pomodoro-accent: #dc2626; 
            --reset-btn-bg: #9ca3af; 
            --reset-btn-hover: #6b7280;
            --logo-content: "ODAK VE BA≈ûARI";
            --logo-accent: #059669;
            --task-bg: #f9fafb;
            --task-completed-bg: #e5e7eb;
            --day-header-color: #1f2937;
        }

        /* SPIDERMAN - Temanƒ±n K√∂kten Deƒüi≈ümesi */
        body[data-theme="spiderman"] {
            --bg-color: #c0392b; 
            --container-bg: #2c3e50; 
            --header-bg: #2c3e50; 
            --header-text: #ecf0f1; 
            --text-color: #ecf0f1; 
            --border-color: #34495e; 
            --day-bg: #34495e; 
            --accent-color: #f1c40f; 
            --button-bg: #e74c3c; 
            --button-hover: #c0392b; 
            --progress-bg: #3498db;
            --progress-fill: #f1c40f; 
            --pomodoro-bg: #2c3e50;
            --pomodoro-accent: #f1c40f; 
            --reset-btn-bg: #3498db; 
            --reset-btn-hover: #2980b9;
            --logo-content: "üï∏Ô∏è MARVELOUS STUDY üï∏Ô∏è";
            --logo-accent: #ffffff; 
            --task-bg: #34495e;
            --task-completed-bg: #475569;
            --day-header-color: #ffffff;
        }


        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Inter', sans-serif;
        }

        body {
            background-color: var(--bg-color);
            color: var(--text-color);
            padding: 20px;
            transition: background-color 0.3s, color 0.3s;
            min-height: 100vh;
        }

        /* Genel Buton Stili */
        button {
            padding: 10px 15px;
            border-radius: 8px;
            border: none;
            cursor: pointer;
            font-weight: 600;
            transition: background-color 0.2s, transform 0.1s, box-shadow 0.2s;
            background-color: var(--button-bg);
            color: var(--header-text); 
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        
        /* ======================================= */
        /* ANA YAPI VE L√úKS G√ñR√úN√úM */
        /* ======================================= */

        .container {
            max-width: 1600px; /* Daha geni≈ü alan */
            margin: 0 auto;
            background-color: var(--container-bg);
            border-radius: 16px; /* Daha yumu≈üak k√∂≈üe */
            box-shadow: 0 15px 40px rgba(0, 0, 0, 0.3); 
            overflow: hidden;
        }

        header {
            background-color: var(--header-bg);
            color: var(--header-text);
            padding: 30px 40px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            border-bottom: 2px solid var(--border-color);
        }

        header h1 {
            font-size: 2.8em;
            font-weight: 900; 
            letter-spacing: 3px;
            text-transform: uppercase;
        }
        
        header h1::after {
            content: var(--logo-content);
            display: block;
            font-size: 0.4em;
            margin-top: 5px;
            font-weight: 400;
            letter-spacing: 1px;
            color: var(--logo-accent); 
        }
        
        .header-controls {
            display: flex;
            gap: 20px;
            align-items: center;
        }
        
        #total-worked-time {
            font-size: 1.2em;
            font-weight: 700;
            color: var(--accent-color);
            padding: 8px 15px;
            border: 1px solid var(--accent-color);
            border-radius: 8px;
            background-color: var(--task-bg);
        }
        
        /* KRƒ∞Tƒ∞K Hƒ∞ZALAMA KURALI */
        .schedule-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr); 
            border-top: 1px solid var(--border-color);
            overflow-x: auto; 
            min-width: 1400px; /* Yatayda kalmasƒ±nƒ± saƒülar */
        }

        .day-cell {
            padding: 20px 15px;
            border-right: 1px solid var(--border-color);
            background-color: var(--day-bg);
            min-height: 550px;
            display: flex;
            flex-direction: column;
        }
        
        .day-cell:last-child {
            border-right: none;
        }

        /* G√úN BA≈ûLIƒûI ORTALAMA VE STƒ∞L */
        .day-cell h2 {
            font-size: 1.5em;
            font-weight: 700;
            color: var(--day-header-color); 
            text-align: center; /* ORTALANDI */
            border-bottom: 2px solid var(--border-color);
            padding-bottom: 5px;
            margin-bottom: 10px;
        }
        
        /* G√úNL√úK √áALI≈ûMA S√úRESƒ∞ (ƒ∞stenen format) */
        .study-score-header {
             font-size: 1.1em;
             font-weight: 700;
             color: var(--pomodoro-accent); 
             margin: 5px 0 15px 0;
             text-align: center; /* ORTALANDI */
             min-height: 25px;
        }
        
        .task-list {
            list-style: none;
            flex-grow: 1;
            padding: 10px 0;
            overflow-y: auto;
        }

        /* G√ñREV √ñƒûELERƒ∞Nƒ∞N L√úKS STƒ∞Lƒ∞ */
        .task-item {
            background-color: var(--task-bg);
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2); 
            border-left: 5px solid var(--accent-color); 
            transition: all 0.2s;
        }

        .task-item.completed {
            border-left: 5px solid var(--reset-btn-bg); 
            background-color: var(--task-completed-bg); 
            opacity: 0.7;
            text-decoration: line-through;
        }
        
        .task-item .task-text-content {
            font-weight: 400;
            flex-grow: 1;
            margin: 0 10px;
        }
        
        /* ======================================= */
        /* POMODORO MODALI VE KAPATMA TU≈ûU */
        /* ======================================= */

        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.85); /* Daha koyu g√∂lge */
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }

        .pomodoro-content {
            background-color: var(--pomodoro-bg);
            padding: 50px;
            border-radius: 16px;
            box-shadow: 0 20px 50px rgba(0, 0, 0, 0.7);
            max-width: 600px;
            text-align: center;
            position: relative;
        }
        
        /* YENƒ∞ KAPATMA TU≈ûU (X yerine KAPAT) */
        #close-pomodoro-btn {
            position: absolute;
            top: 15px;
            right: 15px;
            background-color: var(--reset-btn-bg);
            color: var(--header-text);
            padding: 8px 12px;
            font-weight: 700;
            font-size: 0.9em;
        }
        
        #close-pomodoro-btn:hover {
            background-color: var(--reset-btn-hover);
        }

        .timer-display {
            font-size: 6em; 
            font-weight: 900;
            color: var(--pomodoro-accent);
            letter-spacing: 2px;
            margin: 10px 0;
        }

        .timer-controls button {
            padding: 12px 25px;
            font-size: 1.1em;
            margin: 8px;
            font-weight: 700;
        }

        #reset-btn {
            background-color: var(--reset-btn-bg); 
            color: var(--header-text); 
        }

        .music-buttons button.active {
            background-color: var(--accent-color);
            box-shadow: 0 0 12px var(--accent-color); 
        }

        /* ALERT KUTUSU */
        .alert-box {
            position: fixed; top: -50px; left: 50%; transform: translateX(-50%);
            background-color: #ef4444; color: white;
            padding: 15px 30px; border-radius: 8px; box-shadow: 0 6px 15px rgba(0, 0, 0, 0.3);
            z-index: 2000; font-weight: 600; opacity: 0; transition: opacity 0.5s, top 0.5s;
        }

    </style>
</head>
<body>

    <div id="custom-alert" class="alert-box"></div> 
    
    <div class="container">
        <header>
            <h1>√ñMER</h1>
            <div class="header-controls">
                <select class="theme-select" onchange="setTheme(this.value)">
                    <option value="default">‚≠ê Luxury Dark Mode</option>
                    <option value="light">‚òÄÔ∏è Light Mode</option>
                    <option value="spiderman">üï∑Ô∏è Spiderman Tema</option>
                </select>
                <span id="total-worked-time">HAFTA: 0 dk</span>
                <button class="pomodoro-btn" onclick="showPomodoroModal()">üçÖ Pomodoro Ba≈ülat</button>
            </div>
        </header>

        <div class="week-nav" style="padding: 15px 40px; display: flex; justify-content: space-between; align-items: center; background-color: var(--button-bg); color: var(--header-text); font-weight: 600;">
            <button class="nav-btn" onclick="changeWeek(-1)" style="background: none; border: 1px solid var(--header-text);">‚¨Ö √ñnceki Hafta</button>
            <span id="week-info" style="font-weight: 900; color: var(--logo-accent);"></span>
            <button class="nav-btn" onclick="changeWeek(1)" style="background: none; border: 1px solid var(--header-text);">Sonraki Hafta ‚û°</button>
        </div>

        <div id="schedule-container">
            <div class="schedule-grid">
                </div>
        </div>
    </div>
    
    <div id="pomodoro-modal" class="modal-overlay">
        <div class="pomodoro-content">
            <button id="close-pomodoro-btn" onclick="hidePomodoroModal()">KAPAT</button>
            <h2 style="text-align: center; font-size: 1.8em; color: var(--header-text);">üçÖ ODAK ZAMANI</h2>

            <div class="time-inputs" style="display: flex; justify-content: center; gap: 15px; margin: 20px 0;">
                <div><label for="study-hours" style="color: var(--text-color);">Saat:</label><input type="number" id="study-hours" value="0" min="0" max="10" style="width: 60px; padding: 8px; border: 1px solid var(--border-color); border-radius: 4px; text-align: center; background: var(--task-bg); color: var(--text-color);"></div>
                <div><label for="study-minutes" style="color: var(--text-color);">Dakika:</label><input type="number" id="study-minutes" value="25" min="0" max="59" style="width: 60px; padding: 8px; border: 1px solid var(--border-color); border-radius: 4px; text-align: center; background: var(--task-bg); color: var(--text-color);"></div>
                <div><label for="study-seconds" style="color: var(--text-color);">Saniye:</label><input type="number" id="study-seconds" value="0" min="0" max="59" style="width: 60px; padding: 8px; border: 1px solid var(--border-color); border-radius: 4px; text-align: center; background: var(--task-bg); color: var(--text-color);"></div>
            </div>

            <div id="timer-display" class="timer-display">00:25:00</div>
            <div id="timer-status" class="timer-status" style="color: var(--accent-color); font-weight: 600; margin-bottom: 20px;">Hazƒ±r.</div>

            <div class="timer-controls">
                <button id="start-btn" onclick="startTimer()">BA≈ûLAT</button>
                <button id="pause-btn" style="display:none;" onclick="pauseTimer()">DURAKLAT</button>
                <button id="reset-btn" onclick="resetTimer(true, true)">SIFIRLA</button>
                <button id="finish-btn" onclick="finishTimer(false)" style="background-color: var(--accent-color);">KAYDET & Bƒ∞Tƒ∞R</button>
            </div>
            
            <div class="music-controls" style="margin-top: 30px; padding-top: 20px; border-top: 1px dashed var(--border-color);">
                <div id="music-title" style="color: var(--header-text); font-weight: 600; margin-bottom: 10px;">üé∂ Fon M√ºziƒüi</div>
                <div class="music-buttons" style="display: flex; justify-content: center; gap: 10px; flex-wrap: wrap;">
                    <button id="rain-btn" onclick="playMusic('rain', this)">üåßÔ∏è Yaƒümur Sesi</button> 
                    <button id="piano-btn" onclick="playMusic('piano', this)">üéπ Soft Piyano</button>
                    <button id="lofi-btn" onclick="playMusic('lofi', this)">‚òï Lofi Hip Hop</button>
                    <button id="classic-btn" onclick="playMusic('classic', this)">üé∏ Klasik Gitar</button>
                    <button id="stop-btn" onclick="stopMusic(this)">üö´ Kapat</button>
                </div>
                
                <div class="volume-control" style="display: flex; justify-content: center; align-items: center; gap: 10px; margin-top: 15px;">
                    <span style="color: var(--text-color);">Ses Seviyesi:</span>
                    <input type="range" id="music-volume" min="0" max="100" step="5" oninput="setVolume(this.value)" style="accent-color: var(--pomodoro-accent);">
                    <span id="volume-display" style="color: var(--text-color);">15%</span>
                </div>
            </div>
        </div>
    </div>
    
    <audio id="audio-player" loop></audio>
    
    <script>
        // =======================================
        // JS GLOBAL AYARLAR (v9.0)
        // =======================================
        
        const DAY_NAMES = ['Pazartesi', 'Salƒ±', '√áar≈üamba', 'Per≈üembe', 'Cuma', 'Cumartesi', 'Pazar'];
        const MUSIC_SOURCES = {
            'rain': 'https://s01.vgmmp3.com/b7/b7405230ef11854.mp3',      
            'piano': 'https://s1.vgmmp3.com/5c/5c8c937be595180.mp3',     
            'lofi': 'https://s1.vgmmp3.com/2b/2b7617b8f9e2053.mp3',      
            'classic': 'https://s1.vgmmp3.com/5f/5f0f35368a5c373.mp3'    
        };

        let currentOpenForm = null;
        let currentWeekOffset = 0;
        let draggedItem = null; 

        // Pomodoro Deƒüi≈ükenleri
        let timerInterval = null;
        let initialSeconds = 25 * 60; 
        let isPaused = false;
        let isTimerRunning = false; 
        let expectedTime = null; 
        let remainingTimeOnPause = initialSeconds * 1000; 

        // HTML5 Audio Deƒüi≈ükenleri
        let audioPlayer;
        let currentTrackId = null; 
        let musicVolume = parseInt(localStorage.getItem('musicVolume') || '15');
        
        // =======================================
        // INITIALIZATION
        // =======================================
        
        function createDayCells() {
             const grid = document.querySelector('.schedule-grid');
             if (!grid) return;

             let htmlContent = '';
             for (let i = 0; i < 7; i++) {
                 // G√úNL√úK √áALI≈ûMA S√úRESƒ∞ ƒ∞√áƒ∞N EK ALAN EKLENDƒ∞
                 htmlContent += `
                     <div id="day-${i}" class="day-cell">
                         <h2>${DAY_NAMES[i]} <span id="date-${i}" style="font-size: 0.6em; font-weight: 400; opacity: 0.7;"></span></h2>
                         <div id="score-${i}" class="study-score-header">√áalƒ±≈üma: 0 dk</div>
                         <div class="cell-content-wrapper" style="flex-grow: 1; display: flex; flex-direction: column;">
                             <ul class="task-list" data-day-index="${i}"></ul>
                             <div id="progress-${i}" class="progress-container-wrapper" style="padding: 10px 0;">
                                 <div class="progress-bar" style="width: 100%; height: 10px; background-color: var(--progress-bg); border-radius: 5px; overflow: hidden;"><div class="progress-fill" style="height: 100%; background-color: var(--progress-fill); width: 0%; transition: width 0.5s ease-in-out;"></div></div>
                             </div>
                             <div class="add-task-form" id="form-${i}" style="padding: 10px 0; display: none; display: flex; gap: 5px; align-items: center;">
                                 <input type="text" placeholder="G√∂revi buraya yazƒ±n..." id="input-${i}" onkeydown="if(event.key === 'Enter') addTask(${i}, this.value)" style="flex-grow: 1; padding: 8px; border: 1px solid var(--border-color); border-radius: 4px; background: var(--task-bg); color: var(--text-color);">
                                 <button onclick="addTask(${i}, document.getElementById('input-${i}').value)" style="padding: 8px 10px; background-color: var(--accent-color);">EKLE</button>
                             </div>
                             <button class="add-task-btn" onclick="showAddTaskForm(${i})" style="background-color: var(--button-bg); margin-top: auto;">+ G√∂rev Ekle</button>
                         </div>
                     </div>
                 `;
             }
             grid.innerHTML = htmlContent;
        }

        document.addEventListener('DOMContentLoaded', () => {
            createDayCells(); 
            
            audioPlayer = document.getElementById('audio-player');
            audioPlayer.volume = musicVolume / 100;

            loadTheme();
            loadWeekFromURL();
            renderSchedule();
            loadPomodoroState();

            document.getElementById('study-hours').addEventListener('input', updateTimerFromInputsAndReset);
            document.getElementById('study-minutes').addEventListener('input', updateTimerFromInputsAndReset);
            document.getElementById('study-seconds').addEventListener('input', updateTimerFromInputsAndReset);

            document.addEventListener('click', function(e) {
                if (currentOpenForm && 
                    !currentOpenForm.contains(e.target) && 
                    !e.target.classList.contains('add-task-btn') &&
                    !e.target.closest('.task-item')) { 
                    closeOpenForm();
                }
            });
            
            syncMusicControls();
            setupDragAndDropListeners();
        });

        // =======================================
        // TEMA Y√ñNETƒ∞Mƒ∞
        // =======================================
        function setTheme(themeName) {
            document.body.setAttribute('data-theme', themeName);
            localStorage.setItem('selectedTheme', themeName);

            // Logoyu g√ºncelleyen ve temanƒ±n K√ñKTEN deƒüi≈ümesini saƒülayan mantƒ±k
            const header = document.querySelector('header h1');
            if (header) {
                const afterContent = themeName === 'light' ? 'ODAK VE BA≈ûARI' : 
                                     themeName === 'spiderman' ? 'üï∏Ô∏è MARVELOUS STUDY üï∏Ô∏è' : 
                                     'LUXURY MANAGEMENT PANEL';
                document.documentElement.style.setProperty('--logo-content', `"${afterContent}"`);
            }
        }

        function loadTheme() {
            const savedTheme = localStorage.getItem('selectedTheme') || 'default';
            setTheme(savedTheme);
            const selectElement = document.querySelector('.theme-select');
            if (selectElement) selectElement.value = savedTheme;
        }

        // =======================================
        // TARƒ∞H VE HAFTA Y√ñNETƒ∞Mƒ∞
        // =======================================
        
        function getStartOfWeek(date) {
            const day = date.getDay(); 
            const diff = date.getDate() - day + (day === 0 ? -6 : 1); 
            const startOfWeek = new Date(date);
            startOfWeek.setDate(diff);
            startOfWeek.setHours(0, 0, 0, 0); 
            return startOfWeek;
        }

        function calculateWeekStart(offset) {
            const today = new Date();
            const startOfWeek = getStartOfWeek(today);
            const targetDate = new Date(startOfWeek);
            targetDate.setDate(startOfWeek.getDate() + (offset * 7));
            return targetDate;
        }

        function renderSchedule() {
            const weekStart = calculateWeekStart(currentWeekOffset);
            const weekEnd = new Date(weekStart);
            weekEnd.setDate(weekStart.getDate() + 6);
            
            const weekStartStr = weekStart.toLocaleDateString('tr-TR', { day: 'numeric', month: 'short' });
            const weekEndStr = weekEnd.toLocaleDateString('tr-TR', { day: 'numeric', month: 'short', year: 'numeric' });
            
            const weekInfoElement = document.getElementById('week-info');
            if (weekInfoElement) {
                weekInfoElement.textContent = `${weekStartStr} - ${weekEndStr}`;
            }

            for (let i = 0; i < 7; i++) {
                const dayDate = new Date(weekStart);
                dayDate.setDate(weekStart.getDate() + i);
                
                const dateElement = document.getElementById(`date-${i}`);
                if (dateElement) {
                    dateElement.textContent = dayDate.toLocaleDateString('tr-TR', { day: 'numeric', month: 'numeric' });
                }
                renderTasks(i);
            }
            
            renderStudyScores();
            updateURL();
        }

        function changeWeek(direction) {
            currentWeekOffset += direction;
            renderSchedule();
        }
        
        function updateURL() {
            const url = new URL(window.location);
            url.searchParams.set('week', currentWeekOffset);
            window.history.pushState({}, '', url);
        }

        function loadWeekFromURL() {
            const params = new URLSearchParams(window.location.search);
            const week = params.get('week');
            if (week !== null) {
                currentWeekOffset = parseInt(week) || 0;
            }
        }
        
        // =======================================
        // G√ñREV Y√ñNETƒ∞Mƒ∞
        // =======================================
        
        function getStorageKey(dayIndex) {
            return `tasks_week_${currentWeekOffset}_day_${dayIndex}`;
        }
        
        function getStorageKeyByOffset(weekOffset, dayIndex) {
            return `tasks_week_${weekOffset}_day_${dayIndex}`;
        }

        function loadTasks(dayIndex) {
            const key = getStorageKey(dayIndex);
            const tasksJson = localStorage.getItem(key);
            return tasksJson ? JSON.parse(tasksJson) : [];
        }

        function saveTasks(dayIndex, tasks) {
            const key = getStorageKey(dayIndex);
            localStorage.setItem(key, JSON.stringify(tasks));
            updateProgress(dayIndex);
        }
        
        function renderTasks(dayIndex) {
            const taskList = document.querySelector(`#day-${dayIndex} .task-list`);
            if (!taskList) return;

            taskList.innerHTML = '';
            const tasks = loadTasks(dayIndex);
            
            tasks.forEach(task => createTaskElement(taskList, dayIndex, task.text, task.completed));
            updateProgress(dayIndex);
        }

        function createTaskElement(taskList, dayIndex, text, completed = false) {
            const listItem = document.createElement('li');
            listItem.className = 'task-item' + (completed ? ' completed' : '');
            listItem.draggable = !completed; 
            listItem.setAttribute('data-task-text', text); 

            listItem.addEventListener('dragstart', (e) => {
                if (completed) { e.preventDefault(); return; }
                draggedItem = listItem;
                e.dataTransfer.effectAllowed = 'move';
                e.dataTransfer.setData('text/plain', text); 
                setTimeout(() => listItem.classList.add('dragging'), 0);
            });
            listItem.addEventListener('dragend', () => {
                if (draggedItem) {
                     draggedItem.classList.remove('dragging');
                     draggedItem = null;
                }
            });

            const taskSpan = document.createElement('span');
            taskSpan.textContent = text;
            taskSpan.className = 'task-text-content';
            
            taskSpan.addEventListener('mousedown', (e) => {
                 if (!completed) { listItem.draggable = true; }
            });
            taskSpan.addEventListener('mouseup', () => {
                 listItem.draggable = false;
            });


            const actionsDiv = document.createElement('div');
            actionsDiv.className = 'task-actions';
            actionsDiv.style.display = 'flex';
            actionsDiv.style.alignItems = 'center';
            actionsDiv.style.gap = '5px';

            const checkbox = document.createElement('input');
            checkbox.type = 'checkbox';
            checkbox.className = 'task-checkbox';
            checkbox.checked = completed;
            checkbox.style.transform = 'scale(1.2)';

            checkbox.addEventListener('change', function(e) {
                e.stopPropagation(); 
                listItem.classList.toggle('completed', this.checked);
                listItem.draggable = !this.checked; 
                updateTaskCompletion(dayIndex, text, this.checked);
            });
            
            const moveButton = document.createElement('button');
            moveButton.innerHTML = '<i class="fas fa-arrow-right"></i>'; 
            moveButton.className = 'move-btn';
            moveButton.style.padding = '5px';
            moveButton.style.borderRadius = '4px';
            moveButton.style.background = 'none';
            moveButton.style.color = 'var(--accent-color)';
            
            moveButton.onclick = function(e) {
                 e.stopPropagation(); 
                 if (listItem.classList.contains('completed')) {
                    showCustomAlert("Tamamlanmƒ±≈ü g√∂revler ta≈üƒ±namaz.");
                    return;
                 }
                 moveTaskToNextDay(dayIndex, text);
            };

            const deleteButton = document.createElement('button');
            deleteButton.innerHTML = '<i class="fas fa-trash-alt"></i>';
            deleteButton.className = 'delete-btn';
            deleteButton.style.background = 'none';
            deleteButton.style.color = 'var(--pomodoro-accent)';
            deleteButton.style.fontSize = '1.1em';
            deleteButton.style.padding = '0 5px';
            
            deleteButton.onclick = function(e) {
                 e.stopPropagation(); 
                 deleteTaskFromStorage(dayIndex, text);
                 listItem.remove();
                 updateProgress(dayIndex); 
            };

            actionsDiv.appendChild(checkbox);
            actionsDiv.appendChild(moveButton); 
            
            listItem.appendChild(actionsDiv);
            listItem.appendChild(taskSpan);
            listItem.appendChild(deleteButton);
            
            taskList.appendChild(listItem);
        }
        
        function addTask(dayIndex, text) {
            const inputText = text.trim();
            if (inputText === "") {
                showCustomAlert("L√ºtfen bir g√∂rev girin.");
                return;
            }
            
            let tasks = loadTasks(dayIndex);
            if (tasks.some(t => t.text === inputText)) {
                 showCustomAlert("Bu g√∂rev zaten listede var.");
                 return;
            }

            tasks.push({ text: inputText, completed: false });
            saveTasks(dayIndex, tasks);
            
            const taskList = document.querySelector(`#day-${dayIndex} .task-list`);
            if (taskList) {
                createTaskElement(taskList, dayIndex, inputText, false);
            }
            
            const inputElement = document.getElementById(`input-${dayIndex}`);
            if(inputElement) inputElement.value = '';
            closeOpenForm();
        }

        function updateTaskCompletion(dayIndex, text, completed) {
            let tasks = loadTasks(dayIndex);
            const taskIndex = tasks.findIndex(t => t.text === text);
            if (taskIndex !== -1) {
                tasks[taskIndex].completed = completed;
                saveTasks(dayIndex, tasks);
            }
        }

        function deleteTaskFromStorage(dayIndex, text) {
            let tasks = loadTasks(dayIndex);
            tasks = tasks.filter(task => task.text !== text);
            saveTasks(dayIndex, tasks);
        }
        
        function moveTaskToNextDay(currentDayIndex, taskText) {
            let currentTasks = loadTasks(currentDayIndex);
            currentTasks = currentTasks.filter(task => task.text !== taskText);
            saveTasks(currentDayIndex, currentTasks);
            
            let nextDayIndex = (currentDayIndex + 1) % 7;
            let targetWeekOffset = currentWeekOffset + (currentDayIndex === 6 ? 1 : 0);

            const nextDayKey = getStorageKeyByOffset(targetWeekOffset, nextDayIndex);

            let nextTasks = JSON.parse(localStorage.getItem(nextDayKey) || '[]');
            nextTasks.push({ text: taskText, completed: false });
            localStorage.setItem(nextDayKey, JSON.stringify(nextTasks));
            
            renderSchedule(); 
            showCustomAlert(`G√∂rev "${taskText}" bir sonraki g√ºne ta≈üƒ±ndƒ±.`, '#38bdf8');
        }

        function showAddTaskForm(dayIndex) {
            const form = document.getElementById(`form-${dayIndex}`);
            const button = document.querySelector(`#day-${dayIndex} .add-task-btn`);
            
            if (currentOpenForm && currentOpenForm !== form) {
                closeOpenForm();
            }
            
            if (form) {
                 const isVisible = form.style.display === 'flex';
                 form.style.display = isVisible ? 'none' : 'flex';
                 if (!isVisible) {
                    document.getElementById(`input-${dayIndex}`).focus();
                    currentOpenForm = form;
                    if(button) button.style.display = 'none';
                 } else {
                     currentOpenForm = null;
                     if(button) button.style.display = 'block';
                 }
            }
        }
        
        function closeOpenForm() {
            if (currentOpenForm) {
                currentOpenForm.style.display = 'none';
                const dayIndex = currentOpenForm.id.split('-')[1];
                const button = document.querySelector(`#day-${dayIndex} .add-task-btn`);
                if(button) button.style.display = 'block';
                currentOpenForm = null;
            }
        }
        
        function updateProgress(dayIndex) {
            const tasks = loadTasks(dayIndex);
            const completedCount = tasks.filter(t => t.completed).length;
            const totalCount = tasks.length;
            
            const progressFill = document.querySelector(`#progress-${dayIndex} .progress-fill`);
            if (progressFill) {
                const percentage = totalCount > 0 ? (completedCount / totalCount) * 100 : 0;
                progressFill.style.width = `${percentage}%`;
            }
        }
        
        // =======================================
        // DRAG AND DROP (Basit versiyon tutuldu)
        // =======================================
        
        function getDragAfterElement(container, y) {
            const draggableElements = [...container.querySelectorAll('.task-item:not(.dragging)')];
            return draggableElements.reduce((closest, child) => {
                const box = child.getBoundingClientRect();
                const offset = y - box.top - box.height / 2;
                if (offset < 0 && offset > closest.offset) {
                    return { offset: offset, element: child };
                } else {
                    return closest;
                }
            }, { offset: Number.NEGATIVE_INFINITY }).element;
        }

        function handleDragOver(e) {
            e.preventDefault(); 
            const currentList = e.currentTarget;
            if (!draggedItem) return; 
            const afterElement = getDragAfterElement(currentList, e.clientY);
            if (afterElement == null) {
                currentList.appendChild(draggedItem);
            } else {
                currentList.insertBefore(draggedItem, afterElement);
            }
        }

        function handleDrop(e) {
            e.preventDefault();
            if (!draggedItem) return;
            const currentList = e.currentTarget;
            const currentDayIndex = parseInt(currentList.dataset.dayIndex);
            
            const reorderedTasks = [];
            const taskElements = currentList.querySelectorAll('.task-item');
            taskElements.forEach(item => {
                const taskText = item.getAttribute('data-task-text');
                const isCompleted = item.querySelector('.task-checkbox').checked;
                reorderedTasks.push({ text: taskText, completed: isCompleted });
            });
            saveTasks(currentDayIndex, reorderedTasks);
            
            draggedItem.classList.remove('dragging');
            draggedItem = null;
        }

        function setupDragAndDropListeners() {
            const taskLists = document.querySelectorAll('.task-list');
            taskLists.forEach(list => {
                list.addEventListener('dragover', handleDragOver);
                list.addEventListener('drop', handleDrop);
            });
        }
        
        // =======================================
        // POMODORO VE S√úRE Y√ñNETƒ∞Mƒ∞
        // =======================================
        
        function savePomodoroState() {
            const state = {
                isRunning: isTimerRunning,
                isPaused: isPaused,
                initialSeconds: initialSeconds,
                remainingTime: isTimerRunning ? expectedTime - Date.now() : remainingTimeOnPause,
                timestamp: Date.now()
            };
            localStorage.setItem('pomodoroState', JSON.stringify(state));
        }

        function loadPomodoroState() {
            const stateJson = localStorage.getItem('pomodoroState');
            if (!stateJson) {
                updateTimerDisplay(initialSeconds * 1000); 
                return;
            }

            const state = JSON.parse(stateJson);
            initialSeconds = state.initialSeconds || 25 * 60;
            
            const hours = Math.floor(initialSeconds / 3600);
            const minutes = Math.floor((initialSeconds % 3600) / 60);
            const seconds = initialSeconds % 60;
            
            const studyHours = document.getElementById('study-hours');
            if(studyHours) studyHours.value = hours;
            const studyMinutes = document.getElementById('study-minutes');
            if(studyMinutes) studyMinutes.value = minutes;
            const studySeconds = document.getElementById('study-seconds');
            if(studySeconds) studySeconds.value = seconds;

            if (state.isRunning && !state.isPaused) {
                const elapsedSinceSave = Date.now() - state.timestamp;
                remainingTimeOnPause = state.remainingTime - elapsedSinceSave;
                
                if (remainingTimeOnPause <= 1000) { 
                    resetTimer(true, true);
                    finishTimer(true); 
                    return;
                }

                isTimerRunning = true;
                isPaused = false;
                expectedTime = Date.now() + remainingTimeOnPause;
                startInterval();
                disableTimerInputs(true);
            } else {
                isTimerRunning = state.isRunning;
                isPaused = state.isPaused;
                remainingTimeOnPause = state.remainingTime;
                updateTimerDisplay(remainingTimeOnPause);
            }
        }
        
        function startInterval() {
            if(timerInterval) clearInterval(timerInterval);
            timerInterval = setInterval(() => updateTimerDisplay(null, true), 100); 
        }

        function updateTimerFromInputs() {
            const hours = getInputValue('study-hours');
            const minutes = getInputValue('study-minutes');
            const seconds = getInputValue('study-seconds');
            
            const newInitialSeconds = (hours * 3600) + (minutes * 60) + seconds;
            initialSeconds = Math.max(0, newInitialSeconds);
        }

        function updateTimerFromInputsAndReset() {
            if (isTimerRunning) return; 
            updateTimerFromInputs();
            resetTimer(true, false); 
            savePomodoroState();
        }

        function showPomodoroModal() {
            const modal = document.getElementById('pomodoro-modal');
            modal.style.display = 'flex';
            document.getElementById('schedule-container').style.display = 'none';
            
            syncMusicControls();
            
            const startBtn = document.getElementById('start-btn');
            const pauseBtn = document.getElementById('pause-btn');
            const statusText = document.getElementById('timer-status');

            if (isTimerRunning && !isPaused) {
                if(startBtn) startBtn.style.display = 'none';
                if(pauseBtn) pauseBtn.style.display = 'inline-block';
                if(statusText) statusText.textContent = "√áALI≈ûIYOR...";
            } else {
                if(startBtn) startBtn.style.display = 'inline-block';
                if(pauseBtn) pauseBtn.style.display = 'none';
                if(statusText) statusText.textContent = isPaused ? "DURAKLATILDI" : "Hazƒ±r.";
            }
            updateTimerDisplay(remainingTimeOnPause);
        }

        function hidePomodoroModal() {
            document.getElementById('pomodoro-modal').style.display = 'none';
            document.getElementById('schedule-container').style.display = 'grid'; // Grid'i geri getir
        }

        function formatTime(totalSeconds) {
            totalSeconds = Math.max(0, totalSeconds || 0); 
            const hours = Math.floor(totalSeconds / 3600);
            const minutes = Math.floor((totalSeconds % 3600) / 60);
            const seconds = Math.floor(totalSeconds % 60);
            
            return `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
        }

        function updateTimerDisplay(msOverride = null, fromInterval = false) {
            let remainingMs;

            if (msOverride !== null) {
                remainingMs = msOverride;
            } else if (isPaused) {
                remainingMs = remainingTimeOnPause;
            } else if (isTimerRunning) {
                remainingMs = expectedTime - Date.now();
            } else {
                remainingMs = initialSeconds * 1000;
            }
            
            if (isTimerRunning && remainingMs <= 100) {
                clearInterval(timerInterval);
                finishTimer(true); 
                return;
            }
            
            remainingTimeOnPause = remainingMs; 
            const totalSeconds = Math.ceil(remainingMs / 1000);

            const timerDisplay = document.getElementById('timer-display');
            if(timerDisplay) timerDisplay.textContent = formatTime(totalSeconds); 
            
            if (fromInterval) {
                 savePomodoroState();
            }
        }

        function startTimer() {
            updateTimerFromInputs(); 
            
            if (initialSeconds <= 0) {
                 showCustomAlert("√áalƒ±≈üma s√ºresi 1 saniyeden az olamaz.");
                 return;
            }
            
            if (isTimerRunning && !isPaused) return; 
            
            disableTimerInputs(true);

            const statusText = document.getElementById('timer-status');
            if(statusText) statusText.textContent = "√áALI≈ûIYOR...";
            const startBtn = document.getElementById('start-btn');
            if(startBtn) startBtn.style.display = 'none';
            const pauseBtn = document.getElementById('pause-btn');
            if(pauseBtn) pauseBtn.style.display = 'inline-block';
            
            if (!isTimerRunning) {
                remainingTimeOnPause = initialSeconds * 1000; 
            }
            
            expectedTime = Date.now() + remainingTimeOnPause;

            isTimerRunning = true;
            isPaused = false;
            
            startInterval();
            updateTimerDisplay();
            
            // M√ºzik Ba≈ülatma
            if (currentTrackId) {
                 audioPlayer.src = MUSIC_SOURCES[currentTrackId];
                 audioPlayer.load();
                 audioPlayer.play().catch(error => {
                    showCustomAlert("Tarayƒ±cƒ± kƒ±sƒ±tlamasƒ± nedeniyle m√ºzik otomatik ba≈ülamadƒ±. L√ºtfen M√ºzik Kontrollerinden manuel ba≈ülatƒ±n.", '#fcd34d');
                 });
            }
        }

        function pauseTimer() {
            if (!isTimerRunning || isPaused) return;

            clearInterval(timerInterval);
            isPaused = true;
            
            const statusText = document.getElementById('timer-status');
            if(statusText) statusText.textContent = "DURAKLATILDI";
            const startBtn = document.getElementById('start-btn');
            if(startBtn) startBtn.style.display = 'inline-block';
            const pauseBtn = document.getElementById('pause-btn');
            if(pauseBtn) pauseBtn.style.display = 'none';
            
            savePomodoroState();
            updateTimerDisplay(); 
        }

        function finishTimer(isCompleted = false) {
            clearInterval(timerInterval);
            
            const initialMs = initialSeconds * 1000;
            const remainingMs = Math.max(0, remainingTimeOnPause);
            const workedTimeMs = initialMs - remainingMs;
            
            const workedMinutes = Math.round(workedTimeMs / 60000); 
            
            isTimerRunning = false;
            isPaused = false;

            if (workedMinutes > 0) {
                const dayIndex = (new Date().getDay() + 6) % 7; 
                const dayName = DAY_NAMES[dayIndex];
                
                saveStudyScore(dayIndex, workedMinutes); 
                
                const formattedScore = formatMinutesToHoursMinutes(workedMinutes);
                let message;
                if (isCompleted) {
                    message = `Tebrikler, √ñmer! ${formattedScore} √ßalƒ±≈üma ba≈üarƒ±yla tamamlandƒ± ve ${dayName} g√ºn√ºne kaydedildi.`;
                } else {
                    message = `√ñmer, ${formattedScore} √ßalƒ±≈üma ${dayName} g√ºn√ºne kaydedildi.`;
                }
                
                showCustomAlert(message, '#38bdf8');
            } else if (!isCompleted && initialSeconds > 0) {
                 showCustomAlert("√áok kƒ±sa √ßalƒ±≈ütƒ±nƒ±z, s√ºre kaydedilmedi.");
            }
            
            resetTimer(true, true); 
            hidePomodoroModal(); 
            localStorage.removeItem('pomodoroState');
        }

        function resetTimer(clearIntervalFlag = true, enableInputs = true) {
            if (clearIntervalFlag) {
                clearInterval(timerInterval);
                timerInterval = null;
            }
            
            isTimerRunning = false;
            isPaused = false;
            
            disableTimerInputs(!enableInputs); 
            
            if (enableInputs) {
                updateTimerFromInputs(); 
            }
            
            remainingTimeOnPause = initialSeconds * 1000; 
            
            const timerDisplay = document.getElementById('timer-display');
            if(timerDisplay) timerDisplay.textContent = formatTime(initialSeconds); 
            
            const statusText = document.getElementById('timer-status');
            if(statusText) statusText.textContent = "Hazƒ±r.";
            const startBtn = document.getElementById('start-btn');
            if(startBtn) startBtn.style.display = 'inline-block';
            const pauseBtn = document.getElementById('pause-btn');
            if(pauseBtn) pauseBtn.style.display = 'none';
            
            localStorage.removeItem('pomodoroState');
        }
        
        function disableTimerInputs(disabled) {
            const hours = document.getElementById('study-hours');
            if(hours) hours.disabled = disabled;
            const minutes = document.getElementById('study-minutes');
            if(minutes) minutes.disabled = disabled;
            const seconds = document.getElementById('study-seconds');
            if(seconds) seconds.disabled = disabled;
        }

        // =======================================
        // PUAN VE S√úRE HESAPLAMALARI
        // =======================================
        
        function getStudyScoreKey() {
            return `study_scores_week_${currentWeekOffset}`;
        }
        
        function loadStudyScores() {
            const key = getStudyScoreKey();
            const scoresJson = localStorage.getItem(key);
            return scoresJson ? JSON.parse(scoresJson) : [0, 0, 0, 0, 0, 0, 0];
        }
        
        function saveStudyScore(dayIndex, minutes) {
            const scores = loadStudyScores();
            scores[dayIndex] += minutes;
            const key = getStudyScoreKey();
            localStorage.setItem(key, JSON.stringify(scores));
            renderStudyScores();
        }
        
        function formatMinutesToHoursMinutes(totalMinutes) {
            if (totalMinutes < 1) return `0 dk`;
            if (totalMinutes < 60) return `${totalMinutes} dk`;
            
            const hours = Math.floor(totalMinutes / 60);
            const minutes = Math.round(totalMinutes % 60); 
            
            if (minutes === 0) return `${hours} sa`;
            return `${hours} sa ${minutes} dk`;
        }

        function renderStudyScores() {
            const scores = loadStudyScores();
            let totalWorkedMinutes = 0;

            for (let i = 0; i < 7; i++) {
                const scoreArea = document.getElementById(`score-${i}`);
                const scoreMinutes = scores[i]; 
                totalWorkedMinutes += scoreMinutes;
                
                if (scoreArea) {
                    // ƒ∞STENEN FORMATTA VE KONUMDA YAZILDI
                    scoreArea.textContent = `√áalƒ±≈üma: ${formatMinutesToHoursMinutes(scoreMinutes)}`;
                }
            }
            
            const totalWorkedDisplay = document.getElementById('total-worked-time');
            if (totalWorkedDisplay) {
                // HAFTA: ≈üeklinde kalmasƒ± istenmi≈ütir
                totalWorkedDisplay.textContent = `HAFTA: ${formatMinutesToHoursMinutes(totalWorkedMinutes)}`;
            }
        }
        
        // =======================================
        // M√úZƒ∞K Y√ñNETƒ∞Mƒ∞
        // =======================================
        
        function syncMusicControls() {
            audioPlayer.volume = musicVolume / 100;
            const volumeInput = document.getElementById('music-volume');
            const volumeDisplay = document.getElementById('volume-display');

            if (volumeInput && volumeDisplay) {
                volumeInput.value = musicVolume;
                volumeDisplay.textContent = `${musicVolume}%`;
            }

            const savedTrackId = localStorage.getItem('currentTrackId');
            currentTrackId = savedTrackId;
            let activeBtn = null;
            
            if (savedTrackId) {
                activeBtn = document.getElementById(`${savedTrackId}-btn`);
                if(MUSIC_SOURCES[savedTrackId]) {
                    audioPlayer.src = MUSIC_SOURCES[savedTrackId];
                    audioPlayer.load();
                }
            } else {
                activeBtn = document.getElementById('stop-btn');
            }
            updateMusicButtonStatus(activeBtn);
            
            const musicTitle = document.getElementById('music-title');
            if(musicTitle) {
                if(activeBtn && savedTrackId) {
                    musicTitle.textContent = `üé∂ Fon M√ºziƒüi: ${activeBtn.textContent.trim().replace(/[^\w\sƒü√º≈ü√∂√ßƒ∞ƒ±]/g, '')}`; 
                } else {
                    musicTitle.textContent = `üé∂ Fon M√ºziƒüi`;
                }
            }
        }

        function playMusic(trackId, button) {
            if (currentTrackId === trackId && !audioPlayer.paused) {
                stopMusic();
                return;
            }
            
            if (currentTrackId && currentTrackId !== trackId) {
                audioPlayer.pause();
            }

            const musicURL = MUSIC_SOURCES[trackId];
            audioPlayer.src = musicURL;
            audioPlayer.load(); 
            
            const playPromise = audioPlayer.play();

            if (playPromise !== undefined) {
                playPromise.then(() => {
                    currentTrackId = trackId;
                    localStorage.setItem('currentTrackId', trackId);
                    updateMusicButtonStatus(button);
                    document.getElementById('music-title').textContent = `üé∂ Fon M√ºziƒüi: ${button.textContent.trim().replace(/[^\w\sƒü√º≈ü√∂√ßƒ∞ƒ±]/g, '')}`;
                }).catch(error => {
                    stopMusic(); 
                    showCustomAlert("M√ºzik Ba≈ülatƒ±lamadƒ±! L√ºtfen tarayƒ±cƒ± ayarlarƒ±nƒ±zdan izin verin.", '#ef4444');
                    console.error("Audio Play Error:", error);
                });
            } else {
                currentTrackId = trackId;
                localStorage.setItem('currentTrackId', trackId);
                updateMusicButtonStatus(button);
                document.getElementById('music-title').textContent = `üé∂ Fon M√ºziƒüi: ${button.textContent.trim().replace(/[^\w\sƒü√º≈ü√∂√ßƒ∞ƒ±]/g, '')}`;
            }
        }

        function stopMusic(button) {
            audioPlayer.pause();
            audioPlayer.removeAttribute('src'); 

            currentTrackId = null;
            updateMusicButtonStatus(button || document.getElementById('stop-btn')); 
            
            localStorage.removeItem('currentTrackId');
            document.getElementById('music-title').textContent = `üé∂ Fon M√ºziƒüi`;
        }

        function setVolume(volume) {
            const volumeInt = parseInt(volume);
            
            audioPlayer.volume = volumeInt / 100; 
            
            const volumeInput = document.getElementById('music-volume');
            if(volumeInput) volumeInput.value = volumeInt;
            const volumeDisplay = document.getElementById('volume-display');
            if(volumeDisplay) volumeDisplay.textContent = `${volumeInt}%`;
            
            localStorage.setItem('musicVolume', volumeInt);
            musicVolume = volumeInt;
        }

        function updateMusicButtonStatus(activeButton) {
            const buttons = document.querySelectorAll('.music-buttons button');
            buttons.forEach(btn => btn.classList.remove('active'));
            
            if (activeButton) {
                activeButton.classList.add('active');
            }
        }
        
        // =======================================
        // HELPER FONKSƒ∞YONLAR & UYARI
        // =======================================
        function getInputValue(elementId) {
            const element = document.getElementById(elementId);
            if (!element) return 0;
            const value = element.value;
            return parseInt(value) || 0; 
        }

        function showCustomAlert(message, backgroundColor = '#ef4444') {
            const alertBox = document.getElementById('custom-alert');
            if (!alertBox) return;
            
            alertBox.style.backgroundColor = backgroundColor;
            alertBox.textContent = message;
            alertBox.style.opacity = '1';
            alertBox.style.top = '30px'; 

            setTimeout(() => {
                alertBox.style.opacity = '0';
                alertBox.style.top = '-50px'; 
            }, 4000);
        }

    </script>
</body>
</html>
